# Docker Compose override for E2E runs
# - Adds ephemeral Postgres, MongoDB, and RabbitMQ
# - Points services to these containers
# - No named volumes: `down -v` wipes all data

services:
  # Databases for tests (ephemeral: no named volumes)
  postgres:
    image: postgres:15-alpine
    container_name: club_management_postgres_e2e
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: auth_service_db
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 20
    networks:
      - club_network

  mongo:
    image: mongo:6.0
    container_name: club_management_mongo_e2e
    command: ["--bind_ip_all"]
    ports:
      - "27017:27017"
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 30
    networks:
      - club_network

  rabbitmq:
    image: rabbitmq:3-management
    container_name: club_management_rabbitmq_e2e
    ports:
      - "5672:5672"
      - "15672:15672"  # Management UI (for debugging)
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
      RABBITMQ_ERLANG_COOKIE: "SWQOKODSQALRPCLNMEQG"
    user: "rabbitmq:rabbitmq"
    volumes:
      - rabbitmq_e2e_data:/var/lib/rabbitmq
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - club_network

  # Override services to point to test DBs and enable auto verify
  auth-service:
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/auth_service_db
      DB_SSL: "false"
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      AUTO_VERIFY_EMAILS: "true"
      NODE_ENV: development
      DB_DIALECT: postgres
      AUTO_MIGRATE: "true"
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      # Use basic status endpoint that doesn't require authentication
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3001/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s

  club-service:
    environment:
      MONGODB_URI: mongodb://mongo:27017/club_service_db?directConnection=true
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
    depends_on:
      mongo:
        condition: service_healthy
    healthcheck:
      # Club exposes /health at root
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3002/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 10s

  event-service:
    environment:
      MONGODB_URI: mongodb://mongo:27017/event_service_db?directConnection=true
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
    depends_on:
      mongo:
        condition: service_healthy
    healthcheck:
      # Event exposes /health at root
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3003/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 10s

  frontend:
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 45s

  kong:
    environment:
      AUTH_SERVICE_URL: http://auth-service:3001
      CLUB_SERVICE_URL: http://club-service:3002
      EVENT_SERVICE_URL: http://event-service:3003
      NOTIFY_SERVICE_URL: http://notify-service:3005

networks:
  club_network:
    driver: bridge

volumes:
  rabbitmq_e2e_data:


