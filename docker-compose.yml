services:

  # Frontend Service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8000}
        - NEXT_PUBLIC_API_TIMEOUT=${NEXT_PUBLIC_API_TIMEOUT:-10000}
        - NEXT_PUBLIC_ENV=${NEXT_PUBLIC_ENV:-development}
        - NEXT_PUBLIC_JWT_STORAGE_KEY=${NEXT_PUBLIC_JWT_STORAGE_KEY:-club_management_token}
        - NEXT_PUBLIC_JWT_REFRESH_STORAGE_KEY=${NEXT_PUBLIC_JWT_REFRESH_STORAGE_KEY:-club_management_refresh_token}
        - NEXT_PUBLIC_APP_NAME=${NEXT_PUBLIC_APP_NAME:-Club Management System}
        - NEXT_PUBLIC_APP_VERSION=${NEXT_PUBLIC_APP_VERSION:-1.0.0}
        - NEXT_PUBLIC_DEBUG=${NEXT_PUBLIC_DEBUG:-true}
    container_name: club_management_frontend
    environment:
      NODE_ENV: production
      PORT: 3000
    ports:
      - "3000:3000"
    networks:
      - club_network
    depends_on:
      - kong
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Club Service
  club-service:
    build:
      context: ./services/club
      dockerfile: Dockerfile
      target: development
    container_name: club_management_club
    environment:
      PORT: 3002
      NODE_ENV: test
      MOCK_DB: false
      MONGODB_URI: ${CLUB_MONGODB_URI}
      API_GATEWAY_SECRET: ${API_GATEWAY_SECRET:-club-mgmt-internal-secret-2024}
    ports:
      - "3002:3002"
    volumes:
      - ./services/club:/app
      - /app/node_modules
    networks:
      - club_network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3002/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # Event Service
  event-service:
    build:
      context: ./services/event
      dockerfile: Dockerfile
      target: development
    container_name: club_management_event
    environment:
      PORT: 3003
      NODE_ENV: development
      MONGODB_URI: ${EVENT_MONGODB_URI}
      API_GATEWAY_SECRET: ${API_GATEWAY_SECRET:-club-mgmt-internal-secret-2024}
    ports:
      - "3003:3003"
    volumes:
      - ./services/event:/app
      - /app/node_modules
    networks:
      - club_network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3003/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # Auth Service
  auth-service:
    build:
      context: ./services/auth
      dockerfile: Dockerfile
    container_name: club_management_auth
    environment:
      DATABASE_URL: ${AUTH_DATABASE_URL}
      RABBITMQ_URL: ${AUTH_RABBITMQ_URL}
      NODE_ENV: development
      PORT: 3001
      DB_DIALECT: postgres
      DB_SSL: true
      JWT_ALGORITHM: RS256
      JWT_EXPIRES_IN: 15m
      REFRESH_TOKEN_SECRET: auth-refresh-secret-change-in-production-min-32-chars
      REFRESH_TOKEN_EXPIRES_IN: 7d
      BCRYPT_ROUNDS: 12
      MAX_LOGIN_ATTEMPTS: 5
      ACCOUNT_LOCK_TIME_MS: 1800000
      RATE_LIMIT_WINDOW_MS: 0
      RATE_LIMIT_MAX_REQUESTS: 0
      FRONTEND_BASE_URL: ${FRONTEND_BASE_URL:-http://localhost:3000}
      FRONTEND_URL: ${FRONTEND_BASE_URL:-http://localhost:3000}
      API_GATEWAY_SECRET: ${API_GATEWAY_SECRET:-club-mgmt-internal-secret-2024}
      AUTO_VERIFY_EMAILS: ${AUTO_VERIFY_EMAILS:-false}
    ports:
      - "3001:3001"
    volumes:
      - ./services/auth:/app
      - /app/node_modules
    networks:
      - club_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3001/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Kong API Gateway (DB-less)
  kong:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: club_management_kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /etc/kong/kong.yml
      KONG_PLUGINS: bundled,jwt-claims-headers,api-gateway-secret
      KONG_LOG_LEVEL: debug
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      # Service URLs - Use environment variables with fallback to local services
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL:-http://auth-service:3001}
      CLUB_SERVICE_URL: ${CLUB_SERVICE_URL:-http://club-service:3002}
      EVENT_SERVICE_URL: ${EVENT_SERVICE_URL:-http://event-service:3003}
      NOTIFY_SERVICE_URL: ${NOTIFY_SERVICE_URL:-http://notify-service:3005}
      API_GATEWAY_SECRET: ${API_GATEWAY_SECRET:-club-mgmt-internal-secret-2024}
      # CORS Configuration
      KONG_CORS_ORIGINS: '["http://localhost:3000", "https://club-frontend-hq5d.onrender.com"]'
      # JWT Public Key
      JWT_RSA_PUBLIC_KEY: |
        -----BEGIN PUBLIC KEY-----
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2EhYreDkbolZ8FytzEA0
        ZkSmwQdG7AcID214WFfaeqFyBLE/JQLkihTDit9WT/mRR87ul0Bb05ZeWTlcDuL4
        O+F3kl3T0kF3IFYINaE3su6jTROV85EJPd51AezLfgZHi2fX5tvf3DS8A6G1537h
        v9ir/m6N5Dpp/zGYJ39vJSsyKCGLV5/wQZkpBERw5QZd7SiphWyK241r/l6w/bm7
        VfpDujgozypl6piR7rGxpFJvW83M7F3yEDx24VKIJUSanPHuShg+H87QYUKmXFnW
        GRIVloTZnrMlU21TELuEn8dc7rAF8VkFSli+FBvea7jDO1Fk7K7gXCn7EsTWpXfz
        ZwIDAQAB
        -----END PUBLIC KEY-----
    ports:
      - "8000:8000"
      - "8443:8443"
      - "8001:8001"
      - "8444:8444"
    networks:
      - club_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Notification Service
  notify-service:
    build:
      context: ./services/notify
      dockerfile: Dockerfile
    container_name: club_management_notify
    env_file:
      - ./services/notify/.env
    environment:
      RABBITMQ_URL: ${NOTIFY_RABBITMQ_URL}
      PORT: 3005
      API_GATEWAY_SECRET: ${API_GATEWAY_SECRET:-club-mgmt-internal-secret-2024}
    ports:
      - "3005:3005"
    volumes:
      - ./services/notify:/app
      - /app/node_modules
      - notify_logs:/app/logs
    networks:
      - club_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3005/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

volumes:
  kong_data:
  notify_logs:

networks:
  club_network:
    driver: bridge