services:

  # Frontend Service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - GIT_COMMIT=${GIT_COMMIT:-local}
        - BUILD_NUMBER=${BUILD_NUMBER:-0}
        - BUILD_TIME=${BUILD_TIME:-}
        - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8000}
        - NEXT_PUBLIC_API_TIMEOUT=${NEXT_PUBLIC_API_TIMEOUT:-10000}
        - NEXT_PUBLIC_ENV=${NEXT_PUBLIC_ENV:-development}
        - NEXT_PUBLIC_JWT_STORAGE_KEY=${NEXT_PUBLIC_JWT_STORAGE_KEY:-club_management_token}
        - NEXT_PUBLIC_JWT_REFRESH_STORAGE_KEY=${NEXT_PUBLIC_JWT_REFRESH_STORAGE_KEY:-club_management_refresh_token}
        - NEXT_PUBLIC_APP_NAME=${NEXT_PUBLIC_APP_NAME:-Club Management System}
        - NEXT_PUBLIC_APP_VERSION=${NEXT_PUBLIC_APP_VERSION:-1.0.0}
        - NEXT_PUBLIC_DEBUG=${NEXT_PUBLIC_DEBUG:-true}
    container_name: club_management_frontend
    environment:
      NODE_ENV: production
      PORT: 3000
    ports:
      - "3000:3000"
    networks:
      - club_network
    depends_on:
      - kong
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Club Service
  club-service:
    build:
      context: ./services/club
      dockerfile: Dockerfile
      args:
        - GIT_COMMIT=${GIT_COMMIT:-local}
        - BUILD_NUMBER=${BUILD_NUMBER:-0}
        - BUILD_TIME=${BUILD_TIME:-}
      target: production
    container_name: club_management_club
    environment:
      PORT: 3002
      NODE_ENV: ${NODE_ENV:-development}
      MOCK_DB: false
      MONGODB_URI: ${CLUB_MONGODB_URI}
      RABBITMQ_URL: ${AUTH_RABBITMQ_URL}
      API_GATEWAY_SECRET: ${API_GATEWAY_SECRET:-local-dev-api-gateway-secret-min-16}
    # ========== SECURITY: Port removed - only accessible via Kong ==========
    # ports:
    #   - "3002:3002"
    networks:
      - club_network
    depends_on:
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3002/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # Event Service
  event-service:
    build:
      context: ./services/event
      dockerfile: Dockerfile
      args:
        - GIT_COMMIT=${GIT_COMMIT:-local}
        - BUILD_NUMBER=${BUILD_NUMBER:-0}
        - BUILD_TIME=${BUILD_TIME:-}
      target: production
    container_name: club_management_event
    environment:
      PORT: 3003
      NODE_ENV: ${NODE_ENV:-development}
      MONGODB_URI: ${EVENT_MONGODB_URI}
      RABBITMQ_URL: ${AUTH_RABBITMQ_URL}
      API_GATEWAY_SECRET: ${API_GATEWAY_SECRET:-local-dev-api-gateway-secret-min-16}
    # ========== SECURITY: Port removed - only accessible via Kong ==========
    # ports:
    #   - "3003:3003"
    networks:
      - club_network
    depends_on:
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3003/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # Auth Service
  auth-service:
    build:
      context: ./services/auth
      dockerfile: Dockerfile
      args:
        - GIT_COMMIT=${GIT_COMMIT:-local}
        - BUILD_NUMBER=${BUILD_NUMBER:-0}
        - BUILD_TIME=${BUILD_TIME:-}
    container_name: club_management_auth
    environment:
      DATABASE_URL: ${AUTH_DATABASE_URL}
      RABBITMQ_URL: ${AUTH_RABBITMQ_URL}
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3001
      DB_DIALECT: postgres
      DB_SSL: ${DB_SSL:-false}
      JWT_ALGORITHM: RS256
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-15m}
      REFRESH_TOKEN_SECRET: ${REFRESH_TOKEN_SECRET:-local-dev-refresh-secret-minimum-32-characters-long}
      REFRESH_TOKEN_EXPIRES_IN: ${REFRESH_TOKEN_EXPIRES_IN:-7d}
      BCRYPT_ROUNDS: ${BCRYPT_ROUNDS:-10}
      MAX_LOGIN_ATTEMPTS: ${MAX_LOGIN_ATTEMPTS:-5}
      ACCOUNT_LOCK_TIME_MS: ${ACCOUNT_LOCK_TIME_MS:-1800000}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-0}
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS:-0}
      FRONTEND_BASE_URL: ${FRONTEND_BASE_URL:-http://localhost:3000}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      API_GATEWAY_SECRET: ${API_GATEWAY_SECRET:-local-dev-api-gateway-secret-min-16}
      AUTO_VERIFY_EMAILS: ${AUTO_VERIFY_EMAILS:-true}
    # ========== SECURITY: Port removed - only accessible via Kong ==========
    # ports:
    #   - "3001:3001"
    networks:
      - club_network
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      # Use basic status endpoint that doesn't require authentication
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3001/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Kong API Gateway (DB-less)
  kong:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: club_management_kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /etc/kong/kong.yml
      KONG_PLUGINS: bundled,jwt-claims-headers,api-gateway-secret
      KONG_LOG_LEVEL: ${KONG_LOG_LEVEL:-warn}
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      # ========== SECURITY: Admin API restricted to localhost ==========
      KONG_ADMIN_LISTEN: "127.0.0.1:8001"
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      # Service URLs - Use environment variables with fallback to local services
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL:-http://auth-service:3001}
      CLUB_SERVICE_URL: ${CLUB_SERVICE_URL:-http://club-service:3002}
      EVENT_SERVICE_URL: ${EVENT_SERVICE_URL:-http://event-service:3003}
      NOTIFY_SERVICE_URL: ${NOTIFY_SERVICE_URL:-http://notify-service:3005}
      IMAGE_SERVICE_URL: ${IMAGE_SERVICE_URL:-http://image-service:3004}
      API_GATEWAY_SECRET: ${API_GATEWAY_SECRET:-local-dev-api-gateway-secret-min-16}
      # CORS Configuration
      KONG_CORS_ORIGINS: ${KONG_CORS_ORIGINS:-'["http://localhost:3000"]'}
      # JWT Public Key
      JWT_RSA_PUBLIC_KEY: |
        -----BEGIN PUBLIC KEY-----
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2EhYreDkbolZ8FytzEA0
        ZkSmwQdG7AcID214WFfaeqFyBLE/JQLkihTDit9WT/mRR87ul0Bb05ZeWTlcDuL4
        O+F3kl3T0kF3IFYINaE3su6jTROV85EJPd51AezLfgZHi2fX5tvf3DS8A6G1537h
        v9ir/m6N5Dpp/zGYJ39vJSsyKCGLV5/wQZkpBERw5QZd7SiphWyK241r/l6w/bm7
        VfpDujgozypl6piR7rGxpFJvW83M7F3yEDx24VKIJUSanPHuShg+H87QYUKmXFnW
        GRIVloTZnrMlU21TELuEn8dc7rAF8VkFSli+FBvea7jDO1Fk7K7gXCn7EsTWpXfz
        ZwIDAQAB
        -----END PUBLIC KEY-----
    ports:
      - "8000:8000"   # HTTP Proxy
      - "8443:8443"   # HTTPS Proxy
      # ========== SECURITY: Admin API not exposed ==========
      # - "8001:8001" # Admin API - REMOVED for security
      # - "8444:8444" # Admin API HTTPS - REMOVED for security
    networks:
      - club_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Image Service
  image-service:
    build:
      context: ./services/image
      dockerfile: Dockerfile
      args:
        - GIT_COMMIT=${GIT_COMMIT:-local}
        - BUILD_NUMBER=${BUILD_NUMBER:-0}
        - BUILD_TIME=${BUILD_TIME:-}
    container_name: club_management_image
    environment:
      PORT: 3004
      NODE_ENV: ${NODE_ENV:-development}
      RABBITMQ_URL: ${IMAGE_RABBITMQ_URL}
      # Storage provider: auto, cloudinary, minio
      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-auto}
      # Cloudinary (leave empty to use MinIO)
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME:-}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY:-}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET:-}
      # MinIO/S3 configuration
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-minio}
      MINIO_PORT: ${MINIO_PORT:-9000}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin_local_dev}
      MINIO_BUCKET: ${MINIO_BUCKET:-club-management}
      MINIO_USE_SSL: ${MINIO_USE_SSL:-false}
      MINIO_PUBLIC_URL: ${MINIO_PUBLIC_URL:-http://localhost:9000}
      # Upload limits
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-10485760}
      MAX_FILES: ${MAX_FILES:-10}
      API_GATEWAY_SECRET: ${API_GATEWAY_SECRET:-local-dev-api-gateway-secret-min-16}
      CLUB_SERVICE_URL: http://club-service:3002
      EVENT_SERVICE_URL: http://event-service:3003
    # ========== SECURITY: Port removed - only accessible via Kong ==========
    # ports:
    #   - "3004:3004"
    networks:
      - club_network
    depends_on:
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3004/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Notification Service
  notify-service:
    build:
      context: ./services/notify
      dockerfile: Dockerfile
    container_name: club_management_notify
    environment:
      RABBITMQ_URL: ${NOTIFY_RABBITMQ_URL:-amqp://rabbitmq:rabbitmq_local_dev@rabbitmq:5672}
      PORT: 3005
      NODE_ENV: ${NODE_ENV:-development}
      API_GATEWAY_SECRET: ${API_GATEWAY_SECRET:-local-dev-api-gateway-secret-min-16}
    # ========== SECURITY: Port removed - only accessible via Kong ==========
    # ports:
    #   - "3005:3005"
    volumes:
      - notify_logs:/app/logs
    networks:
      - club_network
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      # Check if process is listening on port 3005 (service is running, even if RabbitMQ not connected)
      test: ["CMD-SHELL", "node -e \"require('http').get('http://127.0.0.1:3005/', r => process.exit(0)).on('error', () => process.exit(1))\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

volumes:
  kong_data:
  notify_logs:

networks:
  club_network:
    driver: bridge