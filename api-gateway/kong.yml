_format_version: "3.0"

services:
  # Auth Service
  - name: auth-service
    url: ${AUTH_SERVICE_URL}
    tags: [club-management-system, auth]
    plugins:
      - name: api-gateway-secret
        config:
          secret_value: ${API_GATEWAY_SECRET}
    
  # Club Service  
  - name: club-service
    url: ${CLUB_SERVICE_URL}
    tags: [club-management-system, club]
    plugins:
      - name: api-gateway-secret
        config:
          secret_value: ${API_GATEWAY_SECRET}
    
  # Event Service
  - name: event-service
    url: ${EVENT_SERVICE_URL}
    tags: [club-management-system, event]
    plugins:
      - name: api-gateway-secret
        config:
          secret_value: ${API_GATEWAY_SECRET}
    
  # Notification Service
  - name: notify-service
    url: ${NOTIFY_SERVICE_URL}
    tags: [club-management-system, notify]
    plugins:
      - name: api-gateway-secret
        config:
          secret_value: ${API_GATEWAY_SECRET}

routes:
  # Auth Service Public Routes (no JWT required)
  - name: auth-public-route
    service: auth-service
    paths:
      - /api/auth/login
      - /api/auth/register
      - /api/auth/verify-email
      - /api/auth/forgot-password
      - /api/auth/reset-password
      - /api/auth/refresh
      - /api/auth/health
      - /api/auth/liveness
      - /api/auth/readiness
    methods: [GET, POST, PUT, DELETE, OPTIONS]
    strip_path: false
    tags: [auth, public]
    
  # Auth Service Protected Routes (JWT required)
  - name: auth-protected-route
    service: auth-service
    paths:
      - /api/auth/profile
      - /api/auth/change-password
      - /api/auth/logout
      - /api/auth/me
      - /api/auth/cleanup
      - /api/auth/users
    methods: [GET, POST, PUT, DELETE, OPTIONS]
    strip_path: false
    tags: [auth, protected]
    plugins:
      - name: jwt
        tags: [auth-jwt]
        config:
          claims_to_verify:
            - exp
          key_claim_name: iss
          secret_is_base64: false
      - name: jwt-claims-headers
        tags: [auth-claims]
        config:
          claims_to_include:
            - id
            - email
            - role
            - full_name
          header_prefix: "x-user-"
    
  # Club Campaigns Routes (JWT required) - MORE SPECIFIC ROUTES FIRST
  - name: club-campaigns-routes
    service: club-service
    paths:
      - "~/api/clubs/[a-fA-F0-9]{24}/campaigns"
      - "~/api/clubs/[a-fA-F0-9]{24}/campaigns/.*"
    methods: [GET, POST, PUT, DELETE, OPTIONS]
    strip_path: false
    tags: [club, campaigns, protected]
    plugins:
      - name: jwt
        tags: [campaigns-jwt]
        config:
          claims_to_verify:
            - exp
          key_claim_name: iss
          secret_is_base64: false
      - name: jwt-claims-headers
        tags: [campaigns-claims]
        config:
          claims_to_include:
            - id
            - email
            - role
            - full_name
          header_prefix: "x-user-"
    
  # Club Service Public Routes (US007 - Search & Filter)
  - name: club-public-routes
    service: club-service
    paths:
      - /api/clubs
      - /api/clubs/categories
      - /api/clubs/locations
      - /api/clubs/stats
      - /api/clubs/member-count
    methods: [GET, OPTIONS]
    strip_path: false
    tags: [club, public]
        
  # Club Member Management Routes (JWT required)
  - name: club-member-routes
    service: club-service
    paths:
      - "~/api/clubs/[a-fA-F0-9]{24}/members"
      - "~/api/clubs/[a-fA-F0-9]{24}/members/.*"
      - "~/api/users/[a-fA-F0-9-]+/club-roles"
      - "~/api/users/[a-fA-F0-9-]+/applications"
    methods: [GET, POST, PUT, DELETE, OPTIONS]
    strip_path: false
    tags: [club, members, protected]
    plugins:
      - name: jwt
        tags: [members-jwt]
        config:
          claims_to_verify:
            - exp
          key_claim_name: iss
          secret_is_base64: false
      - name: jwt-claims-headers
        tags: [members-claims]
        config:
          claims_to_include:
            - id
            - email
            - role
            - full_name
          header_prefix: "x-user-"
        
  # Simplified Application Management Routes (JWT required)
  - name: club-applications-simple-routes
    service: club-service
    paths:
      - "~/api/clubs/[a-fA-F0-9]{24}/applications/[a-fA-F0-9]{24}/status"
      - "~/api/clubs/[a-fA-F0-9]{24}/applications/[a-fA-F0-9]{24}/approve"
      - "~/api/clubs/[a-fA-F0-9]{24}/applications/[a-fA-F0-9]{24}/reject"
    methods: [PUT, POST, OPTIONS]
    strip_path: false
    tags: [club, applications, simplified, protected]
    plugins:
      - name: jwt
        tags: [applications-simple-jwt]
        config:
          claims_to_verify:
            - exp
          key_claim_name: iss
          secret_is_base64: false
      - name: jwt-claims-headers
        tags: [applications-simple-claims]
        config:
          claims_to_include:
            - id
            - email
            - role
            - full_name
          header_prefix: "x-user-"
        
  # Individual Club Routes (Some public, some protected)
  - name: club-individual-public-routes
    service: club-service
    paths:
      - "~/api/clubs/[a-fA-F0-9]{24}$"
      - "~/api/clubs/[a-fA-F0-9]{24}/recruitments"
    methods: [GET, OPTIONS]
    strip_path: false
    tags: [club, individual, public]
    
  # Club Service Protected Routes (JWT required)
  - name: club-protected-routes
    service: club-service
    paths:
      - /api/clubs
    methods: [POST, PUT, DELETE, OPTIONS]
    strip_path: false
    tags: [club, protected]
    plugins:
      - name: jwt
        tags: [club-jwt]
        config:
          claims_to_verify:
            - exp
          key_claim_name: iss
          secret_is_base64: false
      - name: jwt-claims-headers
        tags: [club-claims]
        config:
          claims_to_include:
            - id
            - email
            - role
            - full_name
          header_prefix: "x-user-"
    
  # Public Campaign Routes
  - name: public-campaign-routes
    service: club-service
    paths:
      - /api/campaigns/published
      - "~/api/campaigns/[a-fA-F0-9]{24}$"
      - "~/api/campaigns/clubs/.*/published"
    methods: [GET, OPTIONS]
    strip_path: false
    tags: [club, public, campaigns]
        
  # Campaign Application Routes (JWT required)
  - name: campaign-application-routes
    service: club-service
    paths:
      - "~/api/campaigns/[a-fA-F0-9]{24}/apply"
      - "~/api/campaigns/[a-fA-F0-9]{24}/applications/.*"
      - "~/api/applications/[a-fA-F0-9]{24}$"
    methods: [GET, POST, PUT, DELETE, OPTIONS]
    strip_path: false
    tags: [club, applications, protected]
    plugins:
      - name: jwt
        tags: [application-jwt]
        config:
          claims_to_verify:
            - exp
          key_claim_name: iss
          secret_is_base64: false
      - name: jwt-claims-headers
        tags: [application-claims]
        config:
          claims_to_include:
            - id
            - email
            - role
            - full_name
          header_prefix: "x-user-"
        
  # Event Service Routes (JWT required)
  - name: event-service-route
    service: event-service
    paths:
      - /api/events
      - /api/events/.*
    methods: [GET, POST, PUT, DELETE, OPTIONS]
    strip_path: false
    tags: [event, protected]
    plugins:
      - name: jwt
        tags: [event-jwt]
        config:
          claims_to_verify:
            - exp
          key_claim_name: iss
          secret_is_base64: false
      - name: jwt-claims-headers
        tags: [event-claims]
        config:
          claims_to_include:
            - id
            - email
            - role
            - full_name
          header_prefix: "x-user-"

  # Notification Service Routes (JWT required)
  - name: notify-service-route
    service: notify-service
    paths:
      - /api/notifications
      - /api/notifications/.*
    methods: [GET, POST, PUT, DELETE, OPTIONS]
    strip_path: false
    tags: [notify, protected]
    plugins:
      - name: jwt
        tags: [notify-jwt]
        config:
          claims_to_verify:
            - exp
          key_claim_name: iss
          secret_is_base64: false
      - name: jwt-claims-headers
        tags: [notify-claims]
        config:
          claims_to_include:
            - id
            - email
            - role
            - full_name
          header_prefix: "x-user-"

consumers:
  - username: club-management-app
    custom_id: club-app-001
    tags: [club-management-system]
    jwt_secrets:
      - key: auth-service  # This must match the 'iss' claim in JWT
        algorithm: RS256
        # Public key from the auth service - will be replaced by start-kong.sh
        rsa_public_key: ${JWT_RSA_PUBLIC_KEY}

plugins:
  # Global CORS plugin
  - name: cors
    config:
      # This will be overridden by the KONG_CORS_ORIGINS environment variable
      origins:
        - "http://localhost:3000" 
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        - PATCH
        - HEAD
      headers:
        - Accept
        - Accept-Language
        - Authorization
        - Content-Type
        - Content-Length
        - X-Requested-With
        - X-API-Gateway-Secret
        - X-User-Id
        - X-User-Email
        - X-User-Role
        - X-User-Full-Name
        - Cache-Control
        - Origin
        - Referer
        - User-Agent
      exposed_headers:
        - "*"
      credentials: true
      max_age: 3600
      preflight_continue: false
    tags: [global, cors]