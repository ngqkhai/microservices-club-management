_format_version: "3.0"
_transform: true

# JWT Consumers (will be configured via setup script)
consumers:
  - username: club-management-system

# Services
services:
  # Auth Service
  - name: auth-service
    host: auth-service
    port: 3001
    protocol: http
    path: /api/auth
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000

  # User Service
  - name: user-service
    host: user-service
    port: 3004
    protocol: http
    path: /api/users
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000

  # Notification Service
  - name: notify-service
    host: notify-service
    port: 3005
    protocol: http
    path: /api/notifications
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000

# Routes
routes:
  # Auth Routes (Public - No JWT required)
  - name: auth-register
    service: auth-service
    paths:
      - /api/auth/register
    methods:
      - POST
    strip_path: false

  - name: auth-login
    service: auth-service
    paths:
      - /api/auth/login
    methods:
      - POST
    strip_path: false

  - name: auth-refresh
    service: auth-service
    paths:
      - /api/auth/refresh
    methods:
      - POST
    strip_path: false

  - name: auth-verify-email
    service: auth-service
    paths:
      - /api/auth/verify-email
    methods:
      - POST
    strip_path: false

  - name: auth-forgot-password
    service: auth-service
    paths:
      - /api/auth/forgot-password
    methods:
      - POST
    strip_path: false

  - name: auth-reset-password
    service: auth-service
    paths:
      - /api/auth/reset-password
    methods:
      - POST
    strip_path: false

  - name: auth-health
    service: auth-service
    paths:
      - /api/auth/health
      - /api/auth/liveness
      - /api/auth/readiness
    methods:
      - GET
    strip_path: false

  # Protected Auth Routes (JWT required)
  - name: auth-protected
    service: auth-service
    paths:
      - /api/auth/me
      - /api/auth/logout
      - /api/auth/change-password
    methods:
      - GET
      - POST
      - PUT
      - DELETE
    strip_path: false

  # User Service Routes (Internal sync endpoint - no auth required)
  - name: user-sync
    service: user-service
    paths:
      - /api/users/sync/users
    methods:
      - POST
    strip_path: false

  # User Service Routes (Protected - JWT required)
  - name: user-protected
    service: user-service
    paths:
      - /api/users/me
      - /api/users/me/clubs
    methods:
      - GET
      - PUT
      - DELETE
    strip_path: false

  # User Service Health Routes (Public)
  - name: user-health
    service: user-service
    paths:
      - /health
      - /liveness
      - /readiness
    methods:
      - GET
    strip_path: false

  # Notification Routes (All protected)
  - name: notify-routes
    service: notify-service
    paths:
      - /api/notifications
    methods:
      - GET
      - POST
      - PUT
      - DELETE
    strip_path: false

# Plugins
plugins:
  # JWT Plugin for Protected Routes
  - name: jwt
    route: auth-protected
    config:
      key_claim_name: kid
      claims_to_verify:
        - exp
        - aud
        - iss
      secret_is_base64: false
      run_on_preflight: true

  - name: jwt
    route: user-protected
    config:
      key_claim_name: kid
      claims_to_verify:
        - exp
        - aud
        - iss
      secret_is_base64: false
      run_on_preflight: true

  - name: jwt
    route: notify-routes
    config:
      key_claim_name: kid
      claims_to_verify:
        - exp
        - aud
        - iss
      secret_is_base64: false
      run_on_preflight: true

  # Post-function plugin to extract JWT claims and inject headers
  - name: post-function
    route: auth-protected
    config:
      access:
        - |
          -- JWT Claims Extractor for Kong Gateway
          -- Extracts user claims from validated JWT and injects as headers
          
          -- Get JWT token from Kong context (after JWT plugin validation)
          local jwt_token = kong.ctx.shared.authenticated_jwt_token
          
          if jwt_token and jwt_token.claims then
            -- Kong provides parsed claims after JWT validation
            local claims = jwt_token.claims
            
            -- Extract and inject user headers
            if claims.id then
              kong.service.request.set_header("x-user-id", tostring(claims.id))
            end
            
            if claims.email then
              kong.service.request.set_header("x-user-email", tostring(claims.email))
            end
            
            if claims.role then
              kong.service.request.set_header("x-user-role", tostring(claims.role))
            end
            
            kong.log.info("JWT claims extracted and headers injected for user: " .. tostring(claims.id or "unknown"))
          else
            -- Fallback: Manual JWT parsing if claims not available in context
            local auth_header = kong.request.get_header("authorization")
            if auth_header then
              local token = string.match(auth_header, "Bearer%s+(.+)")
              if token then
                -- Simple Base64 decode and JSON parse (no external dependencies)
                local jwt_parts = {}
                for part in string.gmatch(token, "[^%.]+") do
                  table.insert(jwt_parts, part)
                end
                
                if #jwt_parts >= 2 then
                  -- Decode payload (second part)
                  local payload_b64 = jwt_parts[2]
                  
                  -- Add padding if needed for Base64 decoding
                  local padding = 4 - (#payload_b64 % 4)
                  if padding < 4 then
                    payload_b64 = payload_b64 .. string.rep("=", padding)
                  end
                  
                  -- Base64 decode
                  local payload_json = ngx.decode_base64(payload_b64)
                  
                  if payload_json then
                    -- Extract claims using string patterns (no cjson in sandbox)
                    local id = string.match(payload_json, '"id"%s*:%s*"([^"]+)"')
                    local email = string.match(payload_json, '"email"%s*:%s*"([^"]+)"')
                    local role = string.match(payload_json, '"role"%s*:%s*"([^"]+)"')
                    
                    -- Inject headers
                    if id then
                      kong.service.request.set_header("x-user-id", id)
                    end
                    if email then
                      kong.service.request.set_header("x-user-email", email)
                    end
                    if role then
                      kong.service.request.set_header("x-user-role", role)
                    end
                    
                    kong.log.info("JWT claims extracted via fallback method for user: " .. (id or "unknown"))
                  end
                end
              end
            end
          end

  - name: post-function
    route: user-protected
    config:
      access:
        - |
          -- JWT Claims Extractor for Kong Gateway
          -- Extracts user claims from validated JWT and injects as headers
          
          -- Get JWT token from Kong context (after JWT plugin validation)
          local jwt_token = kong.ctx.shared.authenticated_jwt_token
          
          if jwt_token and jwt_token.claims then
            -- Kong provides parsed claims after JWT validation
            local claims = jwt_token.claims
            
            -- Extract and inject user headers
            if claims.id then
              kong.service.request.set_header("x-user-id", tostring(claims.id))
            end
            
            if claims.email then
              kong.service.request.set_header("x-user-email", tostring(claims.email))
            end
            
            if claims.role then
              kong.service.request.set_header("x-user-role", tostring(claims.role))
            end
            
            kong.log.info("JWT claims extracted and headers injected for user: " .. tostring(claims.id or "unknown"))
          else
            -- Fallback: Manual JWT parsing if claims not available in context
            local auth_header = kong.request.get_header("authorization")
            if auth_header then
              local token = string.match(auth_header, "Bearer%s+(.+)")
              if token then
                -- Simple Base64 decode and JSON parse (no external dependencies)
                local jwt_parts = {}
                for part in string.gmatch(token, "[^%.]+") do
                  table.insert(jwt_parts, part)
                end
                
                if #jwt_parts >= 2 then
                  -- Decode payload (second part)
                  local payload_b64 = jwt_parts[2]
                  
                  -- Add padding if needed for Base64 decoding
                  local padding = 4 - (#payload_b64 % 4)
                  if padding < 4 then
                    payload_b64 = payload_b64 .. string.rep("=", padding)
                  end
                  
                  -- Base64 decode
                  local payload_json = ngx.decode_base64(payload_b64)
                  
                  if payload_json then
                    -- Extract claims using string patterns (no cjson in sandbox)
                    local id = string.match(payload_json, '"id"%s*:%s*"([^"]+)"')
                    local email = string.match(payload_json, '"email"%s*:%s*"([^"]+)"')
                    local role = string.match(payload_json, '"role"%s*:%s*"([^"]+)"')
                    
                    -- Inject headers
                    if id then
                      kong.service.request.set_header("x-user-id", id)
                    end
                    if email then
                      kong.service.request.set_header("x-user-email", email)
                    end
                    if role then
                      kong.service.request.set_header("x-user-role", role)
                    end
                    
                    kong.log.info("JWT claims extracted via fallback method for user: " .. (id or "unknown"))
                  end
                end
              end
            end
          end

  - name: post-function
    route: notify-routes
    config:
      access:
        - |
          -- JWT Claims Extractor for Kong Gateway
          -- Extracts user claims from validated JWT and injects as headers
          
          -- Get JWT token from Kong context (after JWT plugin validation)
          local jwt_token = kong.ctx.shared.authenticated_jwt_token
          
          if jwt_token and jwt_token.claims then
            -- Kong provides parsed claims after JWT validation
            local claims = jwt_token.claims
            
            -- Extract and inject user headers
            if claims.id then
              kong.service.request.set_header("x-user-id", tostring(claims.id))
            end
            
            if claims.email then
              kong.service.request.set_header("x-user-email", tostring(claims.email))
            end
            
            if claims.role then
              kong.service.request.set_header("x-user-role", tostring(claims.role))
            end
            
            kong.log.info("JWT claims extracted and headers injected for user: " .. tostring(claims.id or "unknown"))
          else
            -- Fallback: Manual JWT parsing if claims not available in context
            local auth_header = kong.request.get_header("authorization")
            if auth_header then
              local token = string.match(auth_header, "Bearer%s+(.+)")
              if token then
                -- Simple Base64 decode and JSON parse (no external dependencies)
                local jwt_parts = {}
                for part in string.gmatch(token, "[^%.]+") do
                  table.insert(jwt_parts, part)
                end
                
                if #jwt_parts >= 2 then
                  -- Decode payload (second part)
                  local payload_b64 = jwt_parts[2]
                  
                  -- Add padding if needed for Base64 decoding
                  local padding = 4 - (#payload_b64 % 4)
                  if padding < 4 then
                    payload_b64 = payload_b64 .. string.rep("=", padding)
                  end
                  
                  -- Base64 decode
                  local payload_json = ngx.decode_base64(payload_b64)
                  
                  if payload_json then
                    -- Extract claims using string patterns (no cjson in sandbox)
                    local id = string.match(payload_json, '"id"%s*:%s*"([^"]+)"')
                    local email = string.match(payload_json, '"email"%s*:%s*"([^"]+)"')
                    local role = string.match(payload_json, '"role"%s*:%s*"([^"]+)"')
                    
                    -- Inject headers
                    if id then
                      kong.service.request.set_header("x-user-id", id)
                    end
                    if email then
                      kong.service.request.set_header("x-user-email", email)
                    end
                    if role then
                      kong.service.request.set_header("x-user-role", role)
                    end
                    
                    kong.log.info("JWT claims extracted via fallback method for user: " .. (id or "unknown"))
                  end
                end
              end
            end
          end

  # CORS Plugin
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
        - X-Auth-Token
      exposed_headers:
        - X-Auth-Token
      credentials: true
      max_age: 3600

  # Rate Limiting
  - name: rate-limiting
    config:
      minute: 100
      hour: 1000
      policy: local 